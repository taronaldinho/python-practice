# Python仮想環境
  
インターネット上には世界中のプログラマーが開発して無料で公開している「ライブラリ」や「パッケージ」と呼ばれるPythonのプログラムの "部品" が数多く存在している。特にPythonに標準で付属しているもの以外をサードパーティー製のライブラリ/パッケージと呼んでいる（以下まとめてライブラリとする）。
これらを利用することで私たちは車輪の再発明をすることなく、自分が実現したいことに集中してPythonのコードを書くことができる。

しかし、プロジェクトごとに必要なライブラリやそのバージョンが異なることがよくある。  
コンピューターに、必要なPythonやそのライブラリを都度インストールしていると、以下のような問題に直面する。

1. Pythonやライブラリの依存関係の衝突  
    あるプロジェクトではライブラリのバージョンAが必要で別のプロジェクトではバージョンBが必要な場合、そのライブラリをシステム全体にインストールするとどちらかのプロジェクトが動作しなくなる可能性がある。
2. 環境の作成や再現が困難  
    依存関係の衝突が生じないように必要なPythonやライブラリを注意深くインストールしていくのは非常に困難な作業である。  
    また、あるプロジェクトにおいてどのライブラリのどのバージョンを使っていたのかを記録するのが難しくなる。そのため、後から同じ環境を再現することが難しくなる。
3. システム環境への影響  
    Pythonに依存する他のソフトウェアがある場合、ライブラリのバージョンを変更するとそれらのソフトウェアが動作しなくなる可能性がある（Windows以外のOSではシステム管理用のグローバルなPythonがデフォルトでインストールされていることがあり、そのようなケースで問題が生じる）。

これらの問題を避けるために、**仮想環境** を使うことが推奨されている。仮想環境を作ることで以下のようなメリットがある。

1. 依存関係の衝突回避  
    各プロジェクトごとに独立した環境にPythonやライブラリをインストールできる。プロジェクト間でPythonやライブラリのバージョンが異なっていても問題なく動作させられる。
2. 環境の作成や再現が容易  
    仮想環境を新しく作成すると当然そこはまっさらな状態だ。  
    プロジェクトに必要なライブラリとそのバージョンを記録したファイルを作れる。これにより、他の人やあなた自身が後から同じ環境を再現することが簡単になる。
3. クリーンなシステム環境の維持  
    仮想環境を使えば、コンピューターの不具合が生じるリスクを避けられる。

![[attachments/Pasted image 20241028141051.png]]

仮想環境を作ることは少し手間がかかるように感じるかもしれないが、長期的に見れば、効率的な開発のためになくてはならないものである。

## 基本的な仮想環境の作成・管理方法

Pythonに標準で付属している仮想環境管理ツールとして `venv` がある。
また、ライブラリのインストールのためのツールである `pip` と合わせて使う。

`pip` は、さまざまなライブラリが登録・公開されている [Python Pacage Index（PyPI）](https://pypi.org/) からライブラリをダウンロードし、インストールしてくれる。このとき自動でインストール先のPythonや他のライブラリとの依存関係を解決してくれる。
※PyPI以外の保管場所（リポジトリ）を選択することもできる。

ここでは `venv` と `pip` を使って仮想環境を作成する練習を行う。

### 仮想環境の作成
#### コンピューターにインストールされているPythonを確認する

コンピューターにインストールされている（以降 "グローバルな" と表現する）Pythonは「ターミナル」アプリを起動して、`py --list` と入力しEnterキーを押すことで確認できる。
※メジャーおよびマイナーバージョンのみ表示される。マイクロバージョンの値は表示されない。

![[attachments/Pasted image 20241028150801.png]]

上図の例ではPythonの `3.13` `3.12` `3.11` `3.10` がグローバルなPythonとしてコンピューターにインストールされていることがわかる。
また、バージョン `3.13` のPythonに `*` が表示されているが、これは `py` コマンドでPythonのバージョンを特に指定しない場合にデフォルトで使用されることを示している。


ここで `py -m pip list` と入力してEnterキーを押すと、グローバルなPython `3.13` の環境
にインストールされているライブラリを確認できる。

![[attachments/Pasted image 20241028151443.png]]

この場合、`pip` のバージョン `24.2` のみがインストールされていることがわかる。
#### Pythonのバージョンを指定して仮想環境を作る

ここからグローバルではない、プロジェクトごとに独立した仮想環境を作ってみる。

Windowsのエクスプローラーを起動し仮想環境を作成するフォルダに移動する。
上部のアドレスバーに `wt`（Windows 10では `powershell` ）と入力してEnterキーを押す。

![[attachments/Pasted image 20241028142759.png]]

「ターミナル」（Windows 10では「PowerShell」）が起動する。
シェルのプロンプト `> ` に続けて `mkdir proj_a` と入力しEnterキーを押すと `proj_a` という名前のフォルダが作成される。

![[attachments/Pasted image 20241028143449.png]]

`cd proj_a` と入力しEnterキーを押すと、現在のディレクトリ（フォルダの場所）が今作成した `proj_a` に移動する（プロンプトも変わる）。

![[attachments/Pasted image 20241028143756.png]]

続いて `py -x.y -m venv .venv` と入力しEnterキーを押すと、`.venv` というフォルダが作成される。
ここで `x` にはグローバルにインストールされているPythonのメジャーバージョン、`y` にはマイナーバージョンの実際の数値を入力すること。

※例ではPythonのバージョン `3.10` を指定した。`-x.y` のように指定しなければデフォルトのPython（`*` 印がついていたもの）が指定される。

![[attachments/Pasted image 20241028144330.png]]

#### 仮想環境を有効化しライブラリをインストールする

`.venv\Scripts\Activate.ps1` と入力してEnterキーを押すと、仮想環境が有効化される。
下図のようのプロンプトの先頭に `(.venv)` のように表示されている場合、有効化されていることを示している。

![[attachments/Pasted image 20241028153210.png]]

もし、

![[attachments/Pasted image 20241029075608.png]]

のようなエラーが出て有効化されない場合は、次のコマンドを実行してからもう一度やり直すこと。

`Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force`

仮想環境が有効化されている状態で `pip list` コマンドを実行すると、仮想環境にインストールされているライブラリの一覧が表示されている。
下の例では `pip` のバージョンが異なるなど、グローバルなPython環境との違いが確認出来る。

![[attachments/Pasted image 20241028153634.png]]

続いてこの仮想環境にいくつかライブラリをインストールする。
ライブラリのインストールには、`pip install ライブラリ名` というコマンドを使う。

この `proj_a` 環境には、`selenium` と `pandas` というライブラリをインストールするので、`pip install selenium pandas` と入力してEnterキーを押す。
※ライブラリ名を半角スペース区切りで列挙すれば、複数同時にインストールできる。

⚠️ **注意** 自分がインストールするライブラリの名前は **"正確に"** 入力すること！⚠️
- マルウェアを組み込んだライブラリを正規のライブラリに似た名前でPyPIに登録しておき、ユーザーの入力ミスによってダウンロードさせる手口が確認されている。
- 一般的なライブラリの呼称、`pip install` するときの名前、`import` するときの名前がそれぞれ異なる場合もある（例 日付時刻操作のための `dateutil` はインストールとインポートで名前が異なる ⇒ `pip install python-dateutil` `import dateutil`）。ライブラリの公式ページなどでインストールやインポートの方法をよく確認しておく必要がある。

![[attachments/Pasted image 20241028154216.png]]

ライブラリのインストールが終わるとプロンプトが表示されて入力待ちになる。
ふたたび `pip list` コマンドを実行すると、、、

![[attachments/Pasted image 20241028154242.png]]

明示的にインストールした `selenium` と `pandas` のほかに、これらふたつのライブラリが必要とする（依存関係にある）ライブラリ一式も自動でインストールされている。

#### 仮想環境のPythonを起動する

仮想環境が有効化された状態で `python` コマンドを実行すると仮想環境のPythonインタプリタの対話モードが起動する。

![[attachments/Pasted image 20241028155116.png]]

仮想環境にインストールした `pandas` を使ってみるために、一行ずつ次のように入力していく。

```python
>>> import pandas as pd
>>> series = pd.Series([1, 2, 3, 100], index=["a", "b", "c", "d"])
>>> series
```

最後の `series` の入力後にEnterキーを押すと、次のように表示される。

![[attachments/Pasted image 20241028160014.png]]

このように仮想環境にインストールしたライブラリが動作することが確認出来ればOK。
`exit` 等のコマンドでPythonインタプリタを終了する。

#### 仮想環境の有効化を終了する

仮想環境の有効化を終了するためには `deactivate` コマンドを実行する。

![[attachments/Pasted image 20241028165209.png]]

プロンプトの `(.venv)` 部分がなくなり、仮想環境を抜けたことがわかる。

試しに `py -m pip list` や `py -3.10 -m pip list`（今回の例で使用したPythonに対して）を実行し、グローバルなPython環境には `selenium` や `pandas` がインストールされていないことを確認する。

![[attachments/Pasted image 20241028170742.png]]

#### 仮想環境を複製する

もう一度 `.venv\Scripts\Activate.ps1` を実行し仮想環境を有効化する。

有効化したら、`pip freeze > requirements.txt` と入力し実行する。
`proj_a` フォルダに `requirements.txt` というテキストファイルが作成される。

![[attachments/Pasted image 20241028173102.png]]

この `requirements.txt` を使って同じ `proj_a` と同じライブラリバージョンの仮想環境を作成することができる。

1. `proj_a` フォルダと同じ階層に `proj_b` フォルダを作成する。
2. `proj_b` フォルダに、`proj_a` フォルダの `requirements.txt` をコピペする。
3. `proj_b` で「ターミナル」を起動するか `proj_b` に移動して、`py -x.y -m venv .venv`  を実行する。このとき `proj_a` と同じバージョンのPythonを指定すること。
4. `.venv\Scripts\Activate.ps1` を実行して仮想環境を有効化する。
5. `pip install -r requirements.txt` を実行すると `proj_a` と同じライブラリバージョンの仮想環境が構築される（`pip list` で確認してみること）。

#### 仮想環境を削除する

仮想環境を削除する場合は `proj_a` フォルダごと `.venv` フォルダ等を削除する。

また、トップレベルのフォルダはそのままで仮想環境をはじめから作成しなおす場合は、

- `.venv` フォルダを削除してから `py -x.y -m venv .venv` を実行する
- `.venv` フォルダを削除せずに `py -x.y -m venv .venv --clear` を実行する

ふた通りの方法がある。

#### その他の使い方

[[notes/Python/紹介資料/venv pip|venv pip]]

#### その他の仮想環境管理ツール

`venv` と `pip` とを使って、おおむね仮想環境の管理ができる。
しかし、

- 仮想環境で使いたいPythonは、事前に手動でコンピューターにインストールしなければならない。
- 仮想環境の有効化のために `.venv\Scripts\Activate.ps1` を実行しなければならない（少々面倒）。これを忘れると意図せずグローバルなPython環境を使ったりライブラリをインストールしたりしてしまうことに。
- 仮想環境を複製するときは、Pythonのバージョンは手動で指定しなければならない。
- プログラム開発のときだけ必要なライブラリグループと実行環境で必要なライブラリグループとを分けて管理できない。

などの注意点もある。

Pythonの仮想環境管理のためのツールには多くの選択肢があるが、例えば `uv` という比較的新しいサードパーティー製のツールには、

- グローバルなPythonをインストールせずに仮想環境で使うPythonを直接指定して使うことができる。
- 仮想環境を有効化せずにライブラリのインストールが可能。
- 仮想環境を複製する際にPythonのバージョンも同期される。
- 開発環境と実行環境とを分けて管理・複製できる。
- ライブラリインストールなどの動作が速い。

というメリットもある。仮想環境の概念に慣れてきたらこのようなツールを利用するという方法もある。
（`uv` を使って開発 ⇒ `requirement.txt` を作成 ⇒ 実行環境は `venv` `pip` で `requirement.txt` から構築 という方法もある）
